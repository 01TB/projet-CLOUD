version: '3.8'

services:
  # Base de données PostgreSQL avec PostGIS
  database:
    image: postgis/postgis:15-3.3-alpine
    container_name: postgres-signalisation
    restart: unless-stopped
    ports:
      - "${DB_PORT:-5432}:5432"
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d
      - ./database/backup:/backup
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Backend Spring Boot avec Hot Reload
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: springboot-api
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-8080}:8080"
      - "35729:35729"  # Port LiveReload
      - "5005:5005"    # Port Debug (optionnel)
    networks:
      - app-network
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILE:-dev}
      - DB_HOST=database
      - DB_PORT=5432
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - TZ=Africa/Nairobi
      - SPRING_DEVTOOLS_RESTART_ENABLED=true
      - SPRING_DEVTOOLS_LIVERELOAD_ENABLED=true
    volumes:
      # Montage du code source pour hot reload
      - ./backend/src:/app/src
      - ./backend/pom.xml:/app/pom.xml
      # Cache Maven pour accélérer les recompilations
      - maven-cache:/root/.m2
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # TileServer pour cartes offline
  tileserver:
    build:
      context: ./tileserver
      dockerfile: Dockerfile
    container_name: tileserver-antananarivo
    restart: unless-stopped
    ports:
      - "${TILESERVER_PORT:-8081}:8080"
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "node -e \"const http=require('http'); http.get('http://localhost:8080', r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1));\""]
      interval: 30s
      timeout: 10s
      retries: 3

  # Frontend Angular
  frontend:
    build:
      context: ./frontend-web
      dockerfile: Dockerfile
    container_name: angular-app
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-80}:80"
    networks:
      - app-network
    depends_on:
      backend:
        condition: service_healthy
      tileserver:
        condition: service_healthy
    environment:
      - API_URL=http://backend:8080
      - TILESERVER_URL=http://tileserver:8081

networks:
  app-network:
    driver: bridge

volumes:
  postgres-data:
    driver: local
  maven-cache:
    driver: local